{% extends "base.html" %}

{% block title %}Setup - TeleCloud{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-50 via-cyan-50 to-blue-50 py-8 px-4">
    <div class="max-w-2xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1
                class="text-3xl font-bold bg-gradient-to-r from-ag-cyan-500 via-ag-blue-500 to-ag-violet-500 bg-clip-text text-transparent mb-2">
                Setup Your Storage
            </h1>
            <p class="text-slate-600">Connect your Telegram bot in 5 simple steps</p>
        </div>

        <!-- Progress Bar -->
        <div class="mb-8">
            <div class="flex items-center justify-between mb-2">
                <div class="flex-1 h-2 bg-slate-200 rounded-full overflow-hidden">
                    <div id="progress-bar"
                        class="h-full bg-gradient-to-r from-ag-cyan-500 to-blue-500 transition-all duration-300"
                        style="width: 0%"></div>
                </div>
            </div>
            <p class="text-sm text-slate-600 text-center">Step <span id="current-step">1</span> of 5</p>
        </div>

        <!-- Steps Container -->
        <div id="steps-container" class="bg-white/70 backdrop-blur-xl border border-white/20 rounded-2xl shadow-xl p-8">

            <!-- Step 1: Create Bot -->
            <div class="step" id="step-1">
                <div class="flex items-start gap-4 mb-6">
                    <div class="w-12 h-12 rounded-full bg-ag-cyan-100 flex items-center justify-center flex-shrink-0">
                        <span class="text-2xl">ü§ñ</span>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-slate-900">Create Telegram Bot</h2>
                        <p class="text-slate-600 mt-1">This bot will manage your file uploads</p>
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="bg-slate-50 rounded-lg p-4">
                        <h3 class="font-semibold mb-2">Instructions:</h3>
                        <ol class="list-decimal list-inside space-y-2 text-slate-700">
                            <li>Open Telegram and search for <code
                                    class="bg-slate-200 px-2 py-1 rounded">@BotFather</code></li>
                            <li>Send <code class="bg-slate-200 px-2 py-1 rounded">/newbot</code></li>
                            <li>Choose a name (e.g., "My Cloud Storage")</li>
                            <li>Choose a username ending in "bot" (e.g., "mycloud_storage_bot")</li>
                            <li>Copy the bot token (looks like: <code class="text-xs">1234567890:ABCdef...</code>)</li>
                        </ol>
                    </div>

                    <button onclick="nextStep(2)"
                        class="w-full bg-gradient-to-r from-ag-cyan-500 via-ag-blue-500 to-ag-violet-500 text-white font-semibold px-8 py-3 rounded-xl shadow-lg hover:shadow-xl transition-all">
                        Next: Create Channel ‚Üí
                    </button>
                </div>
            </div>

            <!-- Step 2: Create Channel -->
            <div class="step hidden" id="step-2">
                <div class="flex items-start gap-4 mb-6">
                    <div class="w-12 h-12 rounded-full bg-ag-blue-100 flex items-center justify-center flex-shrink-0">
                        <span class="text-2xl">üì¢</span>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-slate-900">Create Private Channel</h2>
                        <p class="text-slate-600 mt-1">Your files will be stored here</p>
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="bg-slate-50 rounded-lg p-4">
                        <h3 class="font-semibold mb-2">Instructions:</h3>
                        <ol class="list-decimal list-inside space-y-2 text-slate-700">
                            <li>In Telegram, tap the ‚úèÔ∏è icon to create new</li>
                            <li>Select "New Channel"</li>
                            <li>Name it anything (e.g., "My Cloud Files")</li>
                            <li>Set it to <strong>Private</strong> (very important!)</li>
                            <li>Skip adding members</li>
                        </ol>
                    </div>

                    <div class="flex gap-3">
                        <button onclick="prevStep(1)"
                            class="flex-1 bg-slate-200 text-slate-700 font-semibold px-6 py-3 rounded-xl hover:bg-slate-300 transition-all">
                            ‚Üê Back
                        </button>
                        <button onclick="nextStep(3)"
                            class="flex-1 bg-gradient-to-r from-ag-cyan-500 via-ag-blue-500 to-ag-violet-500 text-white font-semibold px-6 py-3 rounded-xl shadow-lg hover:shadow-xl transition-all">
                            Next: Add Bot ‚Üí
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 3: Add Bot as Admin -->
            <div class="step hidden" id="step-3">
                <div class="flex items-start gap-4 mb-6">
                    <div class="w-12 h-12 rounded-full bg-ag-violet-100 flex items-center justify-center flex-shrink-0">
                        <span class="text-2xl">üëë</span>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-slate-900">Add Bot as Admin</h2>
                        <p class="text-slate-600 mt-1">Give your bot permission to post files</p>
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="bg-slate-50 rounded-lg p-4">
                        <h3 class="font-semibold mb-2">Instructions:</h3>
                        <ol class="list-decimal list-inside space-y-2 text-slate-700">
                            <li>Open your private channel</li>
                            <li>Tap the channel name at the top</li>
                            <li>Tap "Administrators"</li>
                            <li>Tap "Add Administrator"</li>
                            <li>Search for your bot (the username you created)</li>
                            <li>Give it "Post Messages" permission (at minimum)</li>
                        </ol>
                    </div>

                    <div class="flex gap-3">
                        <button onclick="prevStep(2)"
                            class="flex-1 bg-slate-200 text-slate-700 font-semibold px-6 py-3 rounded-xl hover:bg-slate-300 transition-all">
                            ‚Üê Back
                        </button>
                        <button onclick="nextStep(4)"
                            class="flex-1 bg-gradient-to-r from-ag-cyan-500 via-ag-blue-500 to-ag-violet-500 text-white font-semibold px-6 py-3 rounded-xl shadow-lg hover:shadow-xl transition-all">
                            Next: Get Channel ID ‚Üí
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 4: Get Channel ID -->
            <div class="step hidden" id="step-4">
                <div class="flex items-start gap-4 mb-6">
                    <div class="w-12 h-12 rounded-full bg-ag-cyan-100 flex items-center justify-center flex-shrink-0">
                        <span class="text-2xl">üî¢</span>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-slate-900">Get Channel ID</h2>
                        <p class="text-slate-600 mt-1">Find your channel's unique identifier</p>
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="bg-slate-50 rounded-lg p-4">
                        <h3 class="font-semibold mb-2">Instructions:</h3>
                        <ol class="list-decimal list-inside space-y-2 text-slate-700">
                            <li>Forward any message from your channel to <code
                                    class="bg-slate-200 px-2 py-1 rounded">@userinfobot</code></li>
                            <li>The bot will reply with channel info</li>
                            <li>Copy the "Id" number (e.g., <code class="text-xs">-100123456789</code>)</li>
                            <li>Make sure it starts with <code>-100</code></li>
                        </ol>
                    </div>

                    <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
                        <p class="text-sm text-amber-800">
                            <strong>Note:</strong> The channel ID must start with <code>-100</code> for private
                            channels.
                        </p>
                    </div>

                    <div class="flex gap-3">
                        <button onclick="prevStep(3)"
                            class="flex-1 bg-slate-200 text-slate-700 font-semibold px-6 py-3 rounded-xl hover:bg-slate-300 transition-all">
                            ‚Üê Back
                        </button>
                        <button onclick="nextStep(5)"
                            class="flex-1 bg-gradient-to-r from-ag-cyan-500 via-ag-blue-500 to-ag-violet-500 text-white font-semibold px-6 py-3 rounded-xl shadow-lg hover:shadow-xl transition-all">
                            Next: Connect ‚Üí
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 5: Verify Connection -->
            <div class="step hidden" id="step-5">
                <div class="flex items-start gap-4 mb-6">
                    <div class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center flex-shrink-0">
                        <span class="text-2xl">‚úì</span>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-slate-900">Connect Your Storage</h2>
                        <p class="text-slate-600 mt-1">Enter your credentials to complete setup</p>
                    </div>
                </div>

                <form id="verify-form" class="space-y-4">
                    <div>
                        <label for="bot_token" class="block text-sm font-medium text-slate-700 mb-2">Bot Token</label>
                        <input type="text" id="bot_token" name="bot_token" required class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-white/50 
                                   focus:outline-none focus:ring-2 focus:ring-ag-cyan-500/50 focus:border-ag-cyan-500
                                   transition-all font-mono text-sm"
                            placeholder="1234567890:ABCdefGHIjklMNOpqrsTUVwxyz">
                    </div>

                    <div>
                        <label for="channel_id" class="block text-sm font-medium text-slate-700 mb-2">Channel ID</label>
                        <input type="text" id="channel_id" name="channel_id" required class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-white/50 
                                   focus:outline-none focus:ring-2 focus:ring-ag-cyan-500/50 focus:border-ag-cyan-500
                                   transition-all font-mono text-sm" placeholder="-100123456789">
                    </div>

                    <div id="error-message"
                        class="hidden bg-red-50 border border-red-200 rounded-lg p-4 text-sm text-red-700"></div>
                    <div id="success-message"
                        class="hidden bg-green-50 border border-green-200 rounded-lg p-4 text-sm text-green-700"></div>

                    <div class="flex gap-3">
                        <button type="button" onclick="prevStep(4)"
                            class="flex-1 bg-slate-200 text-slate-700 font-semibold px-6 py-3 rounded-xl hover:bg-slate-300 transition-all">
                            ‚Üê Back
                        </button>
                        <button type="submit" id="verify-btn"
                            class="flex-1 bg-gradient-to-r from-ag-cyan-500 via-ag-blue-500 to-ag-violet-500 text-white font-semibold px-6 py-3 rounded-xl shadow-lg hover:shadow-xl transition-all">
                            Verify & Complete
                        </button>
                    </div>
                </form>
            </div>

        </div>
    </div>
</div>

<script>
    let currentStep = 1;

    function updateProgress() {
        const progress = (currentStep / 5) * 100;
        document.getElementById('progress-bar').style.width = progress + '%';
        document.getElementById('current-step').textContent = currentStep;
    }

    function showStep(stepNum) {
        document.querySelectorAll('.step').forEach(step => step.classList.add('hidden'));
        document.getElementById('step-' + stepNum).classList.remove('hidden');
        currentStep = stepNum;
        updateProgress();
    }

    function nextStep(stepNum) {
        showStep(stepNum);
    }

    function prevStep(stepNum) {
        showStep(stepNum);
    }

    // Handle form submission
    document.getElementById('verify-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const btn = document.getElementById('verify-btn');
        const errorDiv = document.getElementById('error-message');
        const successDiv = document.getElementById('success-message');

        btn.disabled = true;
        btn.textContent = 'Verifying...';
        errorDiv.classList.add('hidden');
        successDiv.classList.add('hidden');

        try {
            const formData = new FormData(e.target);

            const response = await fetch('{{ url_for("onboarding_verify") }}', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (response.ok) {
                successDiv.textContent = 'Connection verified! Redirecting to dashboard...';
                successDiv.classList.remove('hidden');
                setTimeout(() => {
                    window.location.href = '{{ url_for("dashboard") }}';
                }, 1500);
            } else {
                throw new Error(data.error || 'Verification failed');
            }
        } catch (error) {
            errorDiv.textContent = error.message;
            errorDiv.classList.remove('hidden');
            btn.disabled = false;
            btn.textContent = 'Verify & Complete';
        }
    });

    // Initialize
    updateProgress();
</script>
{% endblock %}